#!/bin/zsh

. panel-settings

hi="%{F$COLOUR_HI}"
ul="%{U$COLOUR_HI}"

clock() {
    date +"%d/%m/%Y %H:%M"
}

desktops() {
    desktops=""

    for monitor in $(bspc query -M); do
        desktops+="${hi}[ %{F-}"

        for desktop in $(bspc query -D -m $monitor); do
            if [[ $desktop -eq $(bspc query -D -d focused) ]]; then
                desktops+="$hi$ul$desktop%{F-U-} "
            else
                desktops+="$desktop "
            fi
        done

        desktops="${desktops%?}$hi ]%{F-}"
    done

    echo "$desktops"
}

battery() {
    full=$(cat /sys/class/power_supply/BAT0/charge_full)
    curr=$(cat /sys/class/power_supply/BAT0/charge_now)

    msg=$(cat /sys/class/power_supply/BAT0/status)
    msg+=" "
    msg+=$(printf '%.1f' $(bc -l <<< "($curr / $full) * 100"))
    msg+="%%"

    echo $msg
}

wifi() {
    state=$(cat /sys/class/net/wlo1/operstate)
    ssid=$(iwgetid -r)
    msg=""

    if [[ $state == "up" ]]; then
        msg="$ssid"
    else
        msg="Disconnected"
    fi

    echo $msg
}

while true; do
    buf=""

    buf+="%{c}"
    buf+="$(desktops)"
    buf+="%{r}"
    buf+="$(wifi) | "
    buf+="$(battery) | "
    buf+="$(clock) "

    echo $buf
    sleep 1
done
